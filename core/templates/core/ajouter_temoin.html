{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-10">
  <div class="max-w-6xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <!-- Stepper -->
      <!-- Stepper -->
<div class="overflow-x-auto">
    <ol class="flex items-center w-max space-x-4 mb-8">
      <li class="flex-none">
        <div class="flex items-center">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-600 text-white font-semibold">1</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-indigo-600">Créer citoyen</p>
            <p class="text-xs text-gray-500">Infos personnelles + photo/signature</p>
          </div>
        </div>
      </li>
      <li class="flex-none">
        <div class="flex items-center opacity-60">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 text-gray-700 font-semibold">2</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-700">Ajouter documents</p>
            <p class="text-xs text-gray-500">Pièces justificatives</p>
          </div>
        </div>
      </li>
      <li class="flex-none">
        <div class="flex items-center opacity-60">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 text-gray-700 font-semibold">3</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-700">Ajouter témoins</p>
            <p class="text-xs text-gray-500">Validation humaine</p>
          </div>
        </div>
      </li>
    </ol>
  </div>
  

      <!-- Card -->
      <div class="bg-white shadow-lg rounded-2xl p-6 md:p-8">
        <div class="flex items-center justify-between">
          <h1 class="text-xl md:text-2xl font-semibold text-gray-900">Ajouter un témoin</h1>
          <a href="{% url 'citoyen_detail' citoyen.id %}" class="text-sm text-gray-600 hover:text-gray-900">← Détails citoyen</a>
        </div>

        {% if messages %}
        <div class="mt-4 space-y-2">
          {% for message in messages %}
            <div class="p-3 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% else %}bg-yellow-50 text-yellow-800 border border-yellow-200{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
        {% endif %}
        <form method="post" enctype="multipart/form-data" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            {% csrf_token %}
          
            <!-- Nom -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Nom du témoin</label>
              <input type="text" name="nom" value="{{ form.nom.value|default_if_none:'' }}" required
                     class="mt-1 w-full rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
              {{ form.nom.errors }}
            </div>
          
            <!-- Relation -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Relation</label>
              <input type="text" name="relation" value="{{ form.relation.value|default_if_none:'' }}" required
                     class="mt-1 w-full rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
              {{ form.relation.errors }}
            </div>
          
            <!-- Contact -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Contact</label>
              <input type="text" name="contact" value="{{ form.contact.value|default_if_none:'' }}" required
                     class="mt-1 w-full rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
              {{ form.contact.errors }}
            </div>
          
            <!-- Signature -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Signature</label>
              
                <div class="mt-2 flex items-center gap-2">
                  <button type="button" id="openSignatureCameraBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Ouvrir caméra</button>
                  <button type="button" id="captureSignatureBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hidden">Capturer</button>
                  <button type="button" id="retakeSignatureBtn" class="px-3 py-2 bg-yellow-500 text-white rounded-lg hidden">Reprendre</button>
                  <button type="button" id="chooseSignatureBtn" class="px-3 py-2 border rounded-lg">Choisir un fichier</button>
                </div>
              
                <!-- input file -->
                <input type="file" id="signatureInput" name="signature" accept="image/*"
                       class="hidden mt-1 w-full rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
              
                <!-- Preview zone -->
                <div class="mt-3">
                  <video id="signatureVideo" autoplay playsinline class="hidden w-40 h-40 rounded-lg object-cover border"></video>
                  <canvas id="signatureCanvas" class="hidden"></canvas>
                  <img id="signaturePreview" class="w-40 h-40 object-contain rounded-md hidden ring-1 ring-gray-200 bg-white">
                </div>
              
                {{ form.signature.errors }}
              </div>
              
              
          
            <!-- Boutons -->
            <div class="md:col-span-2 flex items-center justify-between pt-2">
              <a href="{% url 'citoyen_detail' citoyen.id %}"
                 class="px-5 py-2.5 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-50">
                Terminer & voir la fiche
              </a>
              <button type="submit"
                      class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300">
                Ajouter le témoin
              </button>
            </div>
          </form>
          
       
      </div>
    </div>

    <!-- Aperçu carte citoyenne -->
    <aside class="lg:col-span-1">
      <div class="bg-white shadow-lg rounded-2xl p-6 sticky top-6">
        <h2 class="text-base font-semibold text-gray-900 mb-4">Aperçu carte citoyenne</h2>
        <div class="border rounded-xl p-4">
          <div class="flex items-center gap-3">
            {% if citoyen.photo %}
              <img src="{{ citoyen.photo.url }}" class="w-16 h-16 rounded-lg object-cover ring-1 ring-gray-200" />
            {% else %}
              <div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">—</div>
            {% endif %}
            <div>
              <p class="font-semibold text-gray-900">{{ citoyen.prenom }} {{ citoyen.nom }}</p>
              <p class="text-xs text-gray-500">N° {{ citoyen.numero_identite }}</p>
              <p class="text-xs mt-1">
                {% if citoyen.statut == 'valid' %}
                  <span class="px-2 py-0.5 rounded bg-green-100 text-green-700">✅ Valide</span>
                {% elif citoyen.statut == 'invalid' %}
                  <span class="px-2 py-0.5 rounded bg-red-100 text-red-700">❌ Invalide</span>
                {% else %}
                  <span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-700">⏳ En attente</span>
                {% endif %}
              </p>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 items-center">
            <div>
              <p class="text-xs text-gray-500">Né le</p>
              <p class="text-sm font-medium text-gray-800">{{ citoyen.date_naissance|date:"d/m/Y" }}</p>
              <p class="text-xs text-gray-500 mt-1">À {{ citoyen.lieu_naissance }}</p>
            </div>
            <div class="justify-self-end">
              {% if citoyen.qr_code %}
                <img src="{{ citoyen.qr_code.url }}" class="w-20 h-20 rounded-md ring-1 ring-gray-200" />
              {% endif %}
            </div>
          </div>
        </div>
        <a href="{% url 'citoyen_detail' citoyen.id %}"
           class="mt-4 w-full inline-flex items-center justify-center px-4 py-2.5 rounded-xl bg-black text-white hover:bg-gray-800">
          Terminer → Fiche citoyen
        </a>
      </div>
    </aside>
  </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
      const streams = {};
      const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);
    
      async function startCamera(target, facingMode = 'environment') {
        const video = document.getElementById(`${target}Video`);
        const openBtn = document.getElementById(`open${capitalize(target)}CameraBtn`);
        const chooseBtn = document.getElementById(`choose${capitalize(target)}Btn`);
        if (!video) { console.warn('startCamera: video element missing for', target); return; }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Votre navigateur ne supporte pas la caméra (getUserMedia).");
          return;
        }
        try {
          console.log('Requesting camera for', target, 'facingMode=', facingMode);
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
          streams[target] = stream;
          video.srcObject = stream;
          try { await video.play(); } catch (e) { console.warn('video.play blocked', e); }
          video.classList.remove('hidden');
          const capBtn = document.getElementById(`capture${capitalize(target)}Btn`);
          if (capBtn) capBtn.classList.remove('hidden');
          if (openBtn) openBtn.classList.add('hidden');
          if (chooseBtn) chooseBtn.classList.add('hidden');
        } catch (err) {
          console.error('getUserMedia error:', err);
          alert("Impossible d'accéder à la caméra : " + (err.message || err));
        }
      }
    
      function stopCamera(target) {
        const s = streams[target];
        if (s) { s.getTracks().forEach(t => t.stop()); delete streams[target]; }
        const video = document.getElementById(`${target}Video`);
        if (video) { try { video.pause(); } catch (e) {} video.srcObject = null; video.classList.add('hidden'); }
        const capBtn = document.getElementById(`capture${capitalize(target)}Btn`);
        if (capBtn) capBtn.classList.add('hidden');
        const openBtn = document.getElementById(`open${capitalize(target)}CameraBtn`);
        if (openBtn) openBtn.classList.remove('hidden');
        const chooseBtn = document.getElementById(`choose${capitalize(target)}Btn`);
        if (chooseBtn) chooseBtn.classList.remove('hidden');
      }
    
      function captureImage(target) {
        const video = document.getElementById(`${target}Video`);
        const canvas = document.getElementById(`${target}Canvas`);
        const preview = document.getElementById(`${target}Preview`);
        const input = document.getElementById(`${target}Input`);
        if (!video || !canvas || !preview || !input) { console.warn('captureImage: elements missing for', target); return; }
    
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
        canvas.toBlob(blob => {
          if (!blob) { alert("Erreur lors de la capture."); return; }
          const fileName = `${target}_${Date.now()}.jpg`;
          const file = new File([blob], fileName, { type: 'image/jpeg' });
    
          try {
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            console.log('Inserted captured file into input.files for', target, fileName);
          } catch (e) {
            console.warn('Unable to set input.files, fallback stored in window._capturedFallback', e);
            window._capturedFallback = window._capturedFallback || {};
            window._capturedFallback[target] = file;
          }
    
          preview.src = URL.createObjectURL(file);
          preview.classList.remove('hidden');
    
          stopCamera(target);
          const retakeBtn = document.getElementById(`retake${capitalize(target)}Btn`);
          if (retakeBtn) retakeBtn.classList.remove('hidden');
        }, 'image/jpeg', 0.95);
      }
    
      function setupControls(target, facingMode = 'environment') {
        const openBtn = document.getElementById(`open${capitalize(target)}CameraBtn`);
        const captureBtn = document.getElementById(`capture${capitalize(target)}Btn`);
        const retakeBtn = document.getElementById(`retake${capitalize(target)}Btn`);
        const chooseBtn = document.getElementById(`choose${capitalize(target)}Btn`);
        const input = document.getElementById(`${target}Input`);
        const video = document.getElementById(`${target}Video`);
        const preview = document.getElementById(`${target}Preview`);
    
        if (!openBtn && !captureBtn && !retakeBtn && !chooseBtn && !input) {
          console.warn(`setupControls: aucun élément trouvé pour '${target}'. Vérifie les IDs dans le template.`);
          return;
        }
    
        if (openBtn) openBtn.addEventListener('click', e => { e.preventDefault(); startCamera(target, facingMode); });
        if (captureBtn) captureBtn.addEventListener('click', e => { e.preventDefault(); captureImage(target); });
        if (retakeBtn) retakeBtn.addEventListener('click', e => {
          e.preventDefault();
          if (preview) preview.classList.add('hidden');
          if (retakeBtn) retakeBtn.classList.add('hidden');
          startCamera(target, facingMode);
        });
        if (chooseBtn) chooseBtn.addEventListener('click', e => { e.preventDefault(); if (input) input.click(); });
    
        if (input) input.addEventListener('change', e => {
          const [file] = e.target.files || [];
          if (file) {
            if (preview) {
              if (file.type && file.type.startsWith('image/')) {
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
              } else {
                preview.classList.add('hidden'); // non-image selected (pdf/doc) - template can show link
                console.log('Non-image file selected for', target, file.name);
              }
            }
            stopCamera(target);
            if (retakeBtn) retakeBtn.classList.add('hidden');
          }
        });
      }
    
      // **APPELS** — ajoute ou retire selon les cibles présentes dans ton template
      setupControls('signature', 'environment'); // obligatoire pour le témoin
      setupControls('photo', 'environment');     // si tu utilises photo
      setupControls('fichier', 'environment');   // si tu utilises fichier/document
    
      // stop streams on leave / submit
      window.addEventListener('beforeunload', () => { stopCamera('signature'); stopCamera('photo'); stopCamera('fichier'); });
      document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(f => {
        f.addEventListener('submit', () => { stopCamera('signature'); stopCamera('photo'); stopCamera('fichier'); });
      });
    
      console.log('Camera controls initialized (signature, photo, fichier) — vérifie la console pour erreurs.');
    });
    </script>
    
<script>
    // Activation des contrôles caméra + preview pour la signature
    setupControls('signature', 'environment');
  </script>
{% endblock %}

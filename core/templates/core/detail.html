{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-10 space-y-6">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6 px-2 sm:px-0">
    <h1 class="text-2xl font-bold text-gray-800">
      {% comment %} {{ citoyen.prenom }} {{ citoyen.nom }} {% endcomment %}
    </h1>
    <a href="{% url 'citoyens_list' %}" class="text-sm text-gray-500 hover:text-gray-800">
      ← Retour à la liste
    </a>
  </div>
  

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Carte citoyen -->
    <div class="lg:col-span-2 bg-white p-6 shadow-lg rounded-2xl space-y-4">
      <div class="flex items-center gap-4">
        {% if citoyen.photo %}
        <img src="{{ citoyen.photo.url }}" class="w-20 h-20 object-cover rounded-lg ring-1 ring-gray-200"/>
        {% endif %}
        <div>
          <p class="font-semibold text-gray-900">{{ citoyen.prenom }} {{ citoyen.nom }} {{ citoyen.postnom }}</p>
          <p class="text-sm text-gray-500">N° ID: {{ citoyen.numero_identite }}</p>
          <p class="text-xs mt-1">
            {% if citoyen.statut == 'valid' %}
              <span class="px-2 py-0.5 rounded bg-green-100 text-green-700">✅ Valide</span>
            {% elif citoyen.statut == 'invalid' %}
              <span class="px-2 py-0.5 rounded bg-red-100 text-red-700">❌ Invalide</span>
            {% else %}
              <span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-700">⏳ En attente</span>
            {% endif %}
          </p>
        </div>
        <div class="ml-auto">
          {% if citoyen.qr_code %}
          <img src="{{ citoyen.qr_code.url }}" class="w-24 h-24 rounded-lg ring-1 ring-gray-200"/>
          {% endif %}
        </div>
      </div>

      <!-- Infos -->
      <div class="grid grid-cols-2 gap-4 mt-4 text-sm text-gray-700">
        <div>
          <p>Né le : {{ citoyen.date_naissance|date:"d/m/Y" }}</p>
          <p>Lieu : {{ citoyen.lieu_naissance }}</p>
          <p>Province : {{ citoyen.province }}</p>
          <p>Federation : {{ citoyen.federation }}</p>
          <p>Cellule : {{ citoyen.cellule }}</p>
          <p>Adhésion : <span class="font-semibold">{{ citoyen.get_statut_adhesion_display }}</span></p>
        </div>
        <div>
          <p>Documents : {{ documents.count }}</p>
          <p>Témoins : {{ temoins.count }}</p>
        </div>
      </div>

      <!-- Boutons actions -->
      <div class="flex space-x-4 mt-6">
        <a href="{% url 'ajouter_document' citoyen.id %}" 
           class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition">Ajouter Document</a>
        <a href="{% url 'ajouter_temoin' citoyen.id %}" 
           class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition">Ajouter Témoin</a>
        <a href="{% url 'telecharger_carte_image' citoyen_id=citoyen.id %}" 
           class="px-4 py-2 rounded-xl bg-gray-800 text-white hover:bg-gray-900 transition">Télécharger Carte PDF</a>
      </div>

      <!-- Liste Documents -->
      <div class="mt-6">
        <h2 class="font-semibold text-gray-800 mb-2">Documents</h2>
        <ul class="space-y-1">
          {% for doc in documents %}
          <li class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
            <span>{{ doc.type_document }}</span>
            <div class="flex space-x-2">
              <a href="{{ doc.fichier.url }}" class="text-blue-600 hover:underline" target="_blank">Voir</a>
              <a href="{% url 'modifier_document' doc.id %}" 
                 class="text-yellow-600 hover:text-yellow-800">Modifier</a>
              <button 
                onclick="openDeleteModal('{{ doc.id }}')" 
                class="text-red-600 hover:text-red-800">Supprimer</button>
            </div>
          </li>
          
          {% empty %}
          <li class="text-gray-400">Aucun document</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Liste Témoins -->
      <div class="mt-6">
        <h2 class="font-semibold text-gray-800 mb-2">Témoins</h2>
        <ul class="space-y-1">
          {% for temoin in temoins %}
          <li class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
            <div class="flex items-center space-x-3">
              <span>{{ temoin.nom }} ({{ temoin.relation }})</span>
              {% if temoin.signature %}
                <img src="{{ temoin.signature.url }}" class="h-8 object-contain rounded-md"/>
              {% endif %}
            </div>
            <div class="flex space-x-2">
              <a href="{% url 'modifier_temoin' temoin.id %}" 
                 class="text-yellow-600 hover:text-yellow-800">Modifier</a>
              <button 
                onclick="openDeleteTemoinModal('{{ temoin.id }}')" 
                class="text-red-600 hover:text-red-800">Supprimer</button>
            </div>
          </li>
          
          {% empty %}
          <li class="text-gray-400">Aucun témoin</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal suppression -->
<div id="deleteModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-lg font-semibold mb-4">Confirmer la suppression</h2>
      <p class="text-gray-600 mb-6">Voulez-vous vraiment supprimer cet élément ?</p>
      <div class="flex justify-end space-x-3">
        <button onclick="closeDeleteModal()" 
                class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Annuler</button>
        <a id="confirmDeleteBtn" href="#"
           class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Supprimer</a>
      </div>
    </div>
  </div>


  <!-- Modal suppression témoin -->
<div id="deleteTemoinModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-lg font-semibold mb-4">Confirmer la suppression</h2>
      <p class="text-gray-600 mb-6">Voulez-vous vraiment supprimer ce témoin ?</p>
      <div class="flex justify-end space-x-3">
        <button onclick="closeDeleteTemoinModal()" 
                class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Annuler</button>
        <a id="confirmDeleteTemoinBtn" href="#"
           class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Supprimer</a>
      </div>
    </div>
  </div>
  
  <script>
    function openDeleteModal(docId) {
      // Construire l’URL Django vers la vue de suppression
      const url = "{% url 'supprimer_document' 0 %}".replace("0", docId);
      document.getElementById("confirmDeleteBtn").setAttribute("href", url);
  
      // Afficher le modal
      document.getElementById("deleteModal").classList.remove("hidden");
    }
  
    function closeDeleteModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }
  </script>
  <script>
    function openDeleteTemoinModal(temoinId) {
      // Construire l’URL Django vers la vue de suppression
      const url = "{% url 'supprimer_temoin' 0 %}".replace("0", temoinId);
      document.getElementById("confirmDeleteTemoinBtn").setAttribute("href", url);
  
      // Afficher le modal
      document.getElementById("deleteTemoinModal").classList.remove("hidden");
    }
  
    function closeDeleteTemoinModal() {
      document.getElementById("deleteTemoinModal").classList.add("hidden");
    }
  </script>
  
{% endblock %}
